// Generated by CoffeeScript 1.3.3

(function($) {
  return $.fn.timeatEntry = function(options) {
    if (options == null) {
      options = {};
    }
    return $(this).each(function() {
      var $minutes, $original, $seconds, $sep, $wrapper, formatSeconds, isNavKey, preventNonNumericKeystrokes, updateOriginal, updateVisibleTimeFromSeconds;
      $original = $(this);
      $original.hide();
      $minutes = $("<input type='text' class='minutes' />");
      $sep = $("<span class='sep'>:</span>");
      $seconds = $("<input type='text' class='seconds' />");
      $wrapper = $("<div class='timeat_entry'></div>").append($minutes).append($sep).append($seconds);
      $original.after($wrapper);
      updateOriginal = function() {
        return $original.val(parseInt(($minutes.val() || 0) * 60, 10) + parseInt($seconds.val() || 0, 10)).trigger("keyup").trigger("change");
      };
      isNavKey = function(event) {
        return event.keyCode === 46 || event.keyCode === 8 || event.keyCode === 9 || event.keyCode === 27 || event.keyCode === 13 || (event.keyCode === 65 && event.ctrlKey === true) || (event.keyCode >= 35 && event.keyCode <= 39);
      };
      preventNonNumericKeystrokes = function(event) {
        var c;
        if (isNavKey(event)) {
          return;
        }
        c = String.fromCharCode(event.which);
        if (!/\d/.test(c)) {
          event.preventDefault();
        }
      };
      updateVisibleTimeFromSeconds = function(seconds) {
        var minutes;
        if ((seconds != null) && seconds !== "") {
          minutes = Math.floor(seconds / 60);
          seconds = seconds - minutes * 60;
          $minutes.val(minutes);
          return $seconds.val(formatSeconds(seconds));
        }
      };
      formatSeconds = function(seconds) {
        if (seconds < 10) {
          return "0" + (parseInt(seconds, 10) || 0);
        } else {
          return seconds;
        }
      };
      $minutes.bind("keydown", preventNonNumericKeystrokes);
      $seconds.bind("keydown", preventNonNumericKeystrokes);
      $seconds.bind("keyup", function(event) {
        if ($seconds.val() >= 60) {
          $seconds.val(59);
          return $seconds.preventDefault();
        }
      });
      $seconds.bind("blur", function(event) {
        return $seconds.val(formatSeconds($seconds.val()));
      });
      $seconds.add($minutes).bind("keyup", updateOriginal);
      return updateVisibleTimeFromSeconds($original.val());
    });
  };
})(jQuery);
